# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This file contains values for variables referenced from yaml files in the templates directory.
#
# For further information on Helm templating see the documentation at:
#  https://helm.sh/docs/chart_template_guide/values_files/

# Common parameters
#
# Override redpanda.name template
nameOverride: ""
# Override redpanda.fullname template
fullnameOverride: ""
# Default kuberentes cluster domain
clusterDomain: cluster.local
# Additional labels added to all Kubernetes objects
commonLabels: {}

# Redpanda parameters
#
image:
  repository: vectorized/redpanda
  # Redpanda version. This determines the installed version (not Chart.appVersion)
  # The imagePullPolicy will default to Always when the tag is 'latest'
  pullPolicy: IfNotPresent
# Your license key (optional)
license_key: ""
# Your organization name (optional)
organization: ""
#
# Authentication
auth:
  #
  # SASL configuration
  sasl:
    enabled: false
    # user list
    # TODO create user at startup
    users:
      - name: admin
        # Password for the user. This will be used to generate a secret
        # password: password
        # If password isn't given, then the secretName must point to an already existing secret
        # secretName: adminPassword
  #
  # TLS configuration
  tls:
    # Enable global TLS, which turns on TLS by default for all listeners
    # Each listener must include a certificate name in its TLS section
    # Any certificates in auth.tls.certs will still be loaded if enabled is false
    # This is because listeners may enable TLS individually (see listeners.<listener name>.tls.enabled)
    enabled: false
    # list all certificates below, then reference a certificate's name in each listener (see listeners.<listener name>.tls.cert)
    certs:
      # This is the certificate name that is used to associate the certificate with a listener
      # See listeners.<listener group>.tls.cert for more information
      kafka:
        # issuerRef:
        #   name: redpanda-cert1-selfsigned-issuer
        # The caEnabled flag determines whether the ca.crt file is included in the TLS mount path on each Redpanda pod
        caEnabled: true
        # duration: 43800h
      rpc:
        caEnabled: true
      admin:
        caEnabled: true
      proxy:
        caEnabled: true
      schema:
        caEnabled: true
#
      name: admin
      external:
        enabled: false

    # Kafka API listeners
    # The first entry is used to set up the headless service.
    # Kafka external and internal advertised listeners will be
    # derived from the configuration. External advertised listener will be via
    # node port unless load balancer is configured.
    kafka_api:
      - name: kafka
        address: $(POD_IP)
        port: 9092
        external:
          enabled: true
          subdomain: "streaming.rockdata.io"

    # rpc server listener
    rpc_server:
      address: 0.0.0.0
      port: 33145
      external:
        enabled: false

  # panda proxy (listener)
  pandaproxy:
    pandaproxy_api:
    - address: 0.0.0.0
      name: internal
      port: 8082
      external:
        enabled: true

  schema_registry:
    schema_registry_api:
    - address: "0.0.0.0"
      name: schema-registry
      port: 8081
      external:
        enabled: true

  rpk:
    # Enables memory locking.
    enable_memory_locking: false

    # Send usage stats back to vectorized
    enable_usage_stats: true

    # This should be set to true unless with have CPU affinity
    # https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/#static-policy
    #
    # Equivalent to passing the following to redpanda
    # --idle-poll-time-us 0 --thread-affinity 0 --poll-aio 0
    overprovisioned: true

    # Increases the number of allowed asynchronous IO events
    tune_aio_events: false

    # Syncs NTP
    tune_clocksource: false

    # Installs a custom script to process coredumps and save them to the given directory.
    tune_coredump: false

    # Disables hyper-threading, sets the ACPI-cpufreq governor to 'performance'. Additionaly
    # if system reboot is allowed: disables Intel P-States, disables Intel C-States,
    # disables Turbo Boost
    #
    # This is not possible to set to true while running in a container.
    tune_cpu: false

    # Distributes IRQs across cores with the method deemed the most appropriate for the
    # current device type (i.e. NVMe)
    #
    # This is not possible to set to true while running in a container.
    tune_disk_irq: false

  seastar:
    default_log_level: info

statefulset:
  replicas: 3
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: Parallel
  budget:
    maxUnavailable: 1

  # Additional annotations to apply to the Pods of this StatefulSet.

  # Redpanda makes use of a thread per core model which is described here:
  # only be given full cores for requests and limits. The recommendation
  # for memory for Redpanda is at least 2GB per core. These values will also
  # affect the --smp and --memory flags which are passed to Redpanda.
  #
  # Limits are only specified as to provide Guaranteed QoS:
  # https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/#create-a-pod-that-gets-assigned-a-qos-class-of-guaranteed
  #
  # To improve performance further it is recommended to enable CPU Affinity:
  # https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/#static-policy
  #
  # NOTE: You can increase the number of cores but decreasing the number
  # is not supported currently.
  # https://github.com/vectorizedio/redpanda/issues/350#
  resources:
    limits:
      cpu: "1"
      memory: 2.5Gi
  # Redpanda memory parameter can not exceed POD resource memory limit
  # Example calculation:
  # statefulset.redpanda.memory = 0.8 statefulset.resources.limits.memory
  #
  # NOTE: Memory flag does not support float numbers and support only E, P, T, G, M, k suffixes
  # REF:
  # https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory
  # https://kubernetes.io/docs/reference/kubernetes-api/common-definitions/quantity/
  redpanda:
    memory: 2G
    reservedMemory: 400k
  # Inter-Pod Affinity rules for scheduling Pods of this StatefulSet.
  # https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#inter-pod-affinity-and-anti-affinity
  podAffinity: {}
  # Anti-affinity rules for scheduling Pods of this StatefulSet.
  # https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#inter-pod-affinity-and-anti-affinity
  # You may either toggle options below for default anti-affinity rules,
  # or specify the whole set of anti-affinity rules instead of them.
  podAntiAffinity:
    # The topologyKey to be used.
    # Can be used to spread across different nodes, AZs, regions etc.
    topologyKey: kubernetes.io/hostname
    # Type of anti-affinity rules: either `soft`, `hard` or empty value (which
    # disables anti-affinity rules).
    type: soft
    # Weight for `soft` anti-affinity rules.
    # Does not apply for other anti-affinity types.
    weight: 100
  # Node selection constraints for scheduling Pods of this StatefulSet.
  # https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector
  nodeSelector: {}
  # PriorityClassName given to Pods of this StatefulSet
  # https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/#priorityclass
  priorityClassName: ""
  # Taints to be tolerated by Pods of this StatefulSet.
  # https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/
  tolerations: []
  # https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/
    maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway

serviceAccount:
  # Specifies whether a service account should be created
  create: false
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# When using persistent storage the volume will be mounted as root. In order for redpanda to use the volume
# we must set the fsGroup to the uid of redpanda, which is 101
podSecurityContext:
  fsGroup: 101

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000


storage:
  # Absolute path on host to store Redpanda's data.
  # If not specified, then `emptyDir` will be used instead.
  # If specified, but `persistentVolume.enabled` is `true`, then has no effect.
  hostPath: ""

  # If `enabled` is `true` then a PersistentVolumeClaim will be created and
  # used to store Redpanda's data, otherwise `hostPath` is used.
  persistentVolume:
    enabled: true

    size: 100Gi

    # If defined, then `storageClassName: <storageClass>`.
    # If set to "-", then `storageClassName: ""`, which disables dynamic
    # provisioning.
    # If undefined or empty (default), then no `storageClassName` spec is set,
    # so the default provisioner will be chosen (gp2 on AWS, standard on
    # GKE, AWS & OpenStack).
    storageClass: ""

    # Additional labels to apply to the created PersistentVolumeClaims.
    labels: {}
    # Additional annotations to apply to the created PersistentVolumeClaims.
    annotations: {}
